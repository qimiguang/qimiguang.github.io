---
title: æµè§ˆå™¨è·¨åŸŸé—®é¢˜æ€»ç»“ï¼ˆCross-Originï¼‰
date: 2016-02-29 11:59:58
tags:
---

## 1. èƒŒæ™¯

é¦–å…ˆè§£é‡Šä¸€ä¸‹åŒæºç­–ç•¥ï¼š
`åŒæºç­–ç•¥ï¼Œæ˜¯ç”± Netscape æå‡ºçš„ä¸€ä¸ªè‘—åçš„å®‰å…¨ç­–ç•¥ã€‚ç°åœ¨æ‰€æœ‰æ”¯æŒ JavaScript çš„æµè§ˆå™¨éƒ½ä¼šä½¿ç”¨è¿™ä¸ªç­–ç•¥ã€‚æ‰€è°“åŒæºæ˜¯æŒ‡ï¼ŒåŸŸåï¼Œå­åŸŸåï¼Œåè®®ï¼Œç«¯å£éƒ½ç›¸åŒã€‚`

æ—©å‰æµè§ˆå™¨ä¼šé™åˆ¶è„šæœ¬ä¸­å‘èµ·çš„è·¨åŸŸè¯·æ±‚ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨ XMLHttpRequest å¯¹è±¡å‘èµ· HTTP è¯·æ±‚å°±å¿…é¡»éµå®ˆåŒæºç­–ç•¥ã€‚ä½†æ˜¯ HTML çš„ `<script>` æ ‡ç­¾æ˜¯ä¾‹å¤–ï¼Œå¯ä»¥çªç ´åŒæºç­–ç•¥ä»å…¶ä»–æ¥æºè·å–æ•°æ®ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œä¸€äº›äººæƒ³å‡ºäº†å¾ˆ trick çš„æ–¹å¼ï¼šJSONPã€‚

ä½†æ˜¯ï¼Œåœ¨å½“ä»Šçš„ Web å¼€å‘ä¸­ï¼Œä½¿ç”¨è·¨åŸŸ HTTP è¯·æ±‚åŠ è½½å„ç±»èµ„æºï¼ˆåŒ…æ‹¬ JSONã€CSSã€å›¾ç‰‡ã€JavaScript è„šæœ¬ä»¥åŠå…¶å®ƒç±»èµ„æºï¼‰ï¼Œå·²ç»æˆä¸ºäº†ä¸€ç§ååˆ†æ™®éçš„æ–¹å¼ã€‚æ‰€ä»¥ W3C æ¨èäº†ä¸€ç§æ–°çš„æœºåˆ¶ï¼Œå³è·¨æºèµ„æºå…±äº«ï¼ˆCross-Origin Resource Sharing (CORS)ï¼‰ã€‚è¿™ç§æœºåˆ¶è®© Web åº”ç”¨æœåŠ¡å™¨èƒ½æ”¯æŒè·¨ç«™è®¿é—®æ§åˆ¶ï¼Œä»è€Œä½¿å¾—å®‰å…¨åœ°è¿›è¡Œè·¨ç«™æ•°æ®ä¼ è¾“æˆä¸ºå¯èƒ½ã€‚è¦ä½¿ XMLHttpRequest åœ¨ç°ä»£æµè§ˆå™¨ä¸­å¯ä»¥å‘èµ·è·¨åŸŸè¯·æ±‚ï¼š
* æµè§ˆå™¨å¿…é¡»èƒ½æ”¯æŒè·¨æºå…±äº«å¸¦æ¥çš„æ–°çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬è¯·æ±‚å¤´å’Œç­–ç•¥æ‰§è¡Œã€‚
* æœåŠ¡å™¨ç«¯åˆ™éœ€è¦è§£æè¿™äº›æ–°çš„è¯·æ±‚å¤´ï¼Œå¹¶æŒ‰ç…§ç­–ç•¥è¿”å›ç›¸åº”çš„å“åº”å¤´ä»¥åŠæ‰€è¯·æ±‚çš„èµ„æºã€‚

å¥½åœ¨ç°ä»£æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒ CORS äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æœåŠ¡ç«¯å¤„ç†è·¨åŸŸè¯·æ±‚å°±å¯ä»¥ã€‚

<font color="red">ç»“è®ºï¼šæ¨èä½¿ç”¨ CORS</font>

<!-- more --->

## 2. jsonp
JSONPï¼ˆJSON with Paddingï¼‰ï¼Œå¹¶éæ–°çš„æ•°æ®æ ¼å¼ï¼Œè€Œæ˜¯è§£å†³JSONè·¨åŸŸè·å–çš„è§£å†³æ–¹æ¡ˆã€‚ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå›è°ƒå‡½æ•°å’Œæ•°æ®ã€‚å›è°ƒå‡½æ•°æ˜¯å½“å“åº”åˆ°æ¥æ—¶åº”è¯¥åœ¨é¡µé¢ä¸­è°ƒç”¨çš„å‡½æ•°ï¼Œè€Œæ•°æ®å°±æ˜¯ä¼ å…¥å›è°ƒå‡½æ•°ä¸­çš„JSON æ•°æ®ã€‚`å®ƒä¸»è¦åˆ©ç”¨äº† <script/> æ ‡ç­¾å¯¹ javascript æ–‡æ¡£çš„åŠ¨æ€è§£æã€‚`

å®ç°æ­¥éª¤ï¼š

1. é¦–å…ˆåœ¨å®¢æˆ·ç«¯æ³¨å†Œä¸€ä¸ª callback , ç„¶åæŠŠ callback çš„åå­—ä¼ ç»™æœåŠ¡å™¨ã€‚
2. æœåŠ¡å™¨å…ˆç”Ÿæˆ JSON æ•°æ®ã€‚ç„¶åä»¥ JavaScript è¯­æ³•çš„æ–¹å¼ï¼Œç”Ÿæˆä¸€ä¸ª function , function åå­—å°±æ˜¯ä¼ é€’ä¸Šæ¥çš„å‚æ•° callbackã€‚ç„¶åï¼Œå°† JSON æ•°æ®ç›´æ¥ä»¥å…¥å‚çš„æ–¹å¼ï¼Œæ”¾ç½®åˆ° function ä¸­ï¼Œè¿™æ ·å°±ç”Ÿæˆäº†ä¸€æ®µ js è¯­æ³•çš„æ–‡æ¡£ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚
3. æœ€åï¼Œåœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸­è§£æ script æ ‡ç­¾ï¼Œå¹¶æ‰§è¡Œè¿”å›çš„ JavaScript ï¼Œæ­¤æ—¶æ•°æ®ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥åˆ°äº†å®¢æˆ·ç«¯é¢„å…ˆå®šä¹‰å¥½çš„å›è°ƒå‡½æ•°é‡Œã€‚

ä¸‹é¢æ˜¯å…·ä½“å®ç°ä»£ç ï¼š    
### 2.1 å‰ç«¯
```js
<script type="text/javascript">
    function dosomething(jsondata){
        //å¤„ç†è·å¾—çš„jsonæ•°æ®
    }
</script>
<script src="http://example.com/data?callback=dosomething"></script>
```

jQuery å†™æ³•ï¼š
```js
$.ajax({
    url:"",
    dataType:"jsonp",
    data:{
        params:""
        }
}).done(function(data){
    //dosomething..
})
```

ä»…ä»…æ˜¯å®¢æˆ·ç«¯ä½¿ç”¨ jsonp è¯·æ±‚æ•°æ®æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸º jsonp çš„è¯·æ±‚æ˜¯æ”¾åœ¨ script æ ‡ç­¾ä¸­çš„ï¼Œå®ƒè¯·æ±‚åˆ°çš„æ˜¯ä¸€æ®µ js ä»£ç ï¼Œå¦‚æœæœåŠ¡ç«¯è¿”å›äº† json å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šæŠ¥é”™ã€‚æ‰€ä»¥ jsonp è¿”å›æ•°æ®éœ€è¦æœåŠ¡ç«¯åšä¸€äº›å¤„ç†ã€‚

### 2.2 æœåŠ¡ç«¯

ä¸‹é¢æ˜¯ java å®ç°çš„ jsonp çš„ä»£ç ï¼š
```java
	String callback = request.getParameter("callback");  
	String output = callback + "({ name : 'John', age : '19'});"

	resp.setContentType("text/javascript");
	PrintWriter out = resp.getWriter();
	out.println(output);
	
	// prints: jsonp1232617941775({"name" : "John", "age" : "19"}); withCredentials
```

## 3. CORS

<font color="red">[mozilla HTTPè®¿é—®æ§åˆ¶ï¼šCORS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)
ğŸ˜³ğŸ˜³ğŸ˜³çœ‹å®Œè¿™ç¯‡ mozilla çš„å®˜æ–¹ post åï¼Œæ·±æ„Ÿä¸ä¼šæ¯”å®ƒæ€»ç»“çš„æ›´å‡†ç¡®å®Œå–„äº†ï¼Œsoâ€¦â€¦ä¸‹æ–‡ç®€å•ä»‹ç»ï¼Œè¯¦æƒ…ç›´æ¥æŸ¥çœ‹å®ƒå§ã€‚
<font color="red">å¦ä¸€ç¯‡å¥½æ–‡ï¼š[CORS tutorials](http://www.html5rocks.com/en/tutorials/cors/)<font>


è€ƒè™‘åˆ°ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ CORS äº†ï¼Œæ‰€ä»¥å‰ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨æ ‡å‡†çš„ XMLHttpRequest å‘èµ·è·¨ç«™ HTTP è¯·æ±‚ã€‚ CORS æ˜¯é€šè¿‡æ–°å¢ä¸€ç³»åˆ— HTTP headerï¼Œè®©æœåŠ¡å™¨èƒ½å£°æ˜å“ªäº›æ¥æºå¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®è¯¥æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚

Cross-origin requests åˆ†ä¸º simple requests & "not-so-simple requests".

### 3.1 simple requests 
æ‰€è°“ç®€å•è¯·æ±‚ï¼Œæ˜¯æŒ‡ç¬¦åˆå¦‚ä¸‹æ ‡å‡† ï¼š
* HTTP Method matches (case-sensitive) one of:
	- HEAD
	- GET
	- POST

å½“æ˜¯ POST è¯·æ±‚æ—¶ï¼ŒContent-Type å¿…é¡»æ˜¯å¦‚ä¸‹å‡ ç§ä¹‹ä¸€ï¼š
	- application/x-www-form-urlencoded
	- multipart/form-data
	- text/plain

åŒæ—¶ï¼Œä¸èƒ½ä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆç±»ä¼¼äº X-Modified è¿™ç§ï¼‰ã€‚

### 3.2 é¢„è¯·æ±‚ï¼ˆnot-so-simple requestsï¼‰
â€œé¢„è¯·æ±‚â€è¦æ±‚å¿…é¡»å…ˆå‘é€ä¸€ä¸ª OPTIONS è¯·æ±‚ç»™ç›®çš„ç«™ç‚¹ï¼Œæ¥æŸ¥æ˜è¿™ä¸ªè·¨ç«™è¯·æ±‚å¯¹äºç›®çš„ç«™ç‚¹æ˜¯ä¸æ˜¯å®‰å…¨å¯æ¥å—çš„ã€‚è¿™æ ·åšï¼Œæ˜¯å› ä¸ºè·¨ç«™è¯·æ±‚å¯èƒ½ä¼šå¯¹ç›®çš„ç«™ç‚¹çš„æ•°æ®é€ æˆç ´åã€‚å½“è¯·æ±‚å…·å¤‡ä»¥ä¸‹æ¡ä»¶ï¼Œå°±ä¼šè¢«å½“æˆé¢„è¯·æ±‚å¤„ç†ï¼š
* è¯·æ±‚ä»¥ GET, HEAD æˆ–è€… POST ä»¥å¤–çš„æ–¹æ³•å‘èµ·è¯·æ±‚ã€‚
* æˆ–è€…ä½¿ç”¨ POSTï¼Œä½†è¯·æ±‚æ•°æ®ä¸º application/x-www-form-urlencoded, multipart/form-data, text/plain ä»¥å¤–çš„æ•°æ®ç±»å‹ã€‚å¦‚: ç”¨ POST å‘é€æ•°æ®ç±»å‹ä¸º application/xml æˆ–è€… application/json çš„æ•°æ®çš„è¯·æ±‚ã€‚
* ä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆæ¯”å¦‚æ·»åŠ è¯¸å¦‚ X-PINGOTHERï¼‰

![preflight](http://www.html5rocks.com/static/images/cors_flow.png)

### 3.3 é™„å¸¦å‡­è¯ä¿¡æ¯çš„è¯·æ±‚
XMLHttpRequest è®¿é—®æ§åˆ¶åŠŸèƒ½ï¼Œæœ€æœ‰è¶£çš„ç‰¹æ€§å°±æ˜¯ï¼Œå‘é€å‡­è¯è¯·æ±‚ï¼ˆHTTP Cookieså’ŒéªŒè¯ä¿¡æ¯ï¼‰çš„åŠŸèƒ½ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå¯¹äºè·¨ç«™è¯·æ±‚ï¼Œæµè§ˆå™¨æ˜¯ä¸ä¼šå‘é€å‡­è¯ä¿¡æ¯çš„ã€‚ä½†å¦‚æœå°† XMLHttpRequest çš„ä¸€ä¸ªç‰¹æ®Šæ ‡å¿—ä½ withCredentials è®¾ç½®ä¸ºtrueï¼Œæµè§ˆå™¨å°±å°†å…è®¸è¯¥è¯·æ±‚çš„å‘é€ã€‚

### 3.4 HTTP å“åº”å¤´
Access-Control-Allow-Origin
Access-Control-Expose-Headers
Access-Control-Max-Age
Access-Control-Allow-Credentials
Access-Control-Allow-Methods
Access-Control-Allow-Headers

### 3.5 HTTP è¯·æ±‚å¤´
Origin
Access-Control-Request-Method
Access-Control-Request-Headers

### 3.6 Spring MVC å¯¹ CORS çš„æ”¯æŒ
Spring offers two methods to support CORS: Controller method CORS configuration & Global CORS configuration, And global and controller level CORS configurations can also be combined.

#### solution 1 : Controller method CORS configuration
you just have to add a @CrossOrigin annotation to the handler method:

`src/main/java/hello/GreetingController.java`
```java
    @CrossOrigin(origins = "http://localhost:9000")
    @RequestMapping("/greeting")
    public @ResponseBody Greeting greeting(@RequestParam(required=false, defaultValue="World") String name) {
        System.out.println("==== in greeting ====");
        return new Greeting(counter.incrementAndGet(), String.format(template, name));
    }
```
You can customize this behavior by specifying the value of one of the annotation attributes: origins, methods, allowedHeaders, exposedHeaders, allowCredentials or maxAge.

#### solution 2 : Global CORS configuration
you can also define some global CORS configuration as well. 

`src/main/java/hello/GreetingController.java`
```java
    @RequestMapping("/greeting-javaconfig")
    public @ResponseBody Greeting greetingWithJavaconfig(@RequestParam(required=false, defaultValue="World") String name) {
        System.out.println("==== in greeting ====");
        return new Greeting(counter.incrementAndGet(), String.format(template, name));
    }
```
`src/main/java/hello/Application.java`
```java
    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurerAdapter() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/greeting-javaconfig").allowedOrigins("http://localhost:9000");
            }
        };
    }
```

### 3.7 Filter
```java
public class CORSFilter implements Filter {

	public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {
		HttpServletResponse response = (HttpServletResponse) res;
		response.setHeader("Access-Control-Allow-Origin", "*");
		response.setHeader("Access-Control-Allow-Methods", "POST, GET, PUT, OPTIONS, DELETE");
		response.setHeader("Access-Control-Max-Age", "3600");
		response.setHeader("Access-Control-Allow-Headers", "x-requested-with");
		chain.doFilter(req, res);
	}

	public void init(FilterConfig filterConfig) {}
	public void destroy() {}
}
```

### 3.8 nginx
å¯ä»¥é€šè¿‡åœ¨ Nginx ä¸Šé…ç½®ï¼Œæ¥è¾¾åˆ° CORS çš„ç›®çš„ï¼Œ[å‚è€ƒæ–‡ç« ](http://enable-cors.org/server_nginx.html)

### 2.3 æ–¹æ¡ˆå¯¹æ¯”

1. JSONP åªæ”¯æŒ GET è¯·æ±‚ï¼Œè€Œ CORS æ”¯æŒæ‰€æœ‰ç±»å‹çš„ HTTP è¯·æ±‚ï¼Œ`å½“ä½¿ç”¨ RESTful æ¶æ„æ—¶ JSONP å°±æ›´æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†`ã€‚
2. ä½¿ç”¨CORSï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨æ™®é€šçš„ XMLHttpRequest å‘èµ·è¯·æ±‚å’Œè·å¾—æ•°æ®ï¼Œæ¯”èµ· JSONP æœ‰æ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚
3. JSONP ä¸»è¦è¢«è€çš„æµè§ˆå™¨æ”¯æŒï¼Œå®ƒä»¬å¾€å¾€ä¸æ”¯æŒ CORS ï¼Œè€Œç»å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº† CORS ã€‚

æ‰€ä»¥ï¼ŒæŠ›å¼ƒ JSONPï¼ŒæŠ•å…¥ CORS çš„æ€€æŠ±å§ï¼ï¼ï¼


